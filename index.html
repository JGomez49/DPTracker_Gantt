


<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CSV + Gantt Viewer</title>
  <style>
    body {
      background-color: #121212;
      color: #e0e0e0;
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 15px;
    }
    th, td {
      border: 1px solid #444;
      padding: 6px 10px;
      text-align: left;
    }
    th {
      background-color: #1e1e1e;
    }
    tr:nth-child(even) {
      background-color: #1a1a1a;
    }
    canvas {
      width: 100% !important;
    }
  </style>
</head>
<body>
  <h2>Upload DP Tracker CSV File</h2>
  <input type="file" id="csvFile" accept=".csv">

  <h3>ðŸ“‹ Table</h3>
  <table id="csvTable"></table>

  <div id="chartContainer"></div>

  <!-- Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.1.0/dist/chartjs-plugin-annotation.min.js"></script>

  <script>
    let chartInstances = [];

    function excelSerialToDate(serial) {
      const utcMillis = (serial - 25569) * 86400 * 1000;
      const d = new Date(Math.round(utcMillis));
      return new Date(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate());
    }
    function parseExcelDate(value) {
      if (value instanceof Date && !isNaN(value)) return value;
      if (typeof value === "number") return excelSerialToDate(value);
      const parsed = Date.parse(value);
      if (!isNaN(parsed)) return new Date(parsed);
      return null;
    }

    document.getElementById('csvFile').addEventListener('change', function(event) {
      const file = event.target.files[0];
      if (!file) return;

      Papa.parse(file, {
        complete: function(results) {
          let data = results.data;
          data = data.filter(row => row.some(cell => cell.trim() !== ""));
          const deleteCols = [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,18,19,20,21,22,23,25,26,27,28];
          data = data.map(row => row.filter((_, idx) => !deleteCols.includes(idx)));

          data = data.map((row, rIdx) => {
            if (rIdx === 0) {
              row.splice(3, 0, "Duration");
            } else {
              let found = "";
              for (let i = 3; i < row.length; i++) {
                if (!isNaN(row[i]) && row[i].trim() !== "") {
                  found = parseFloat(row[i]);
                  break;
                }
              }
              row.splice(3, 0, found || 0);
            }
            return row;
          });

          data = data.map(row => row.slice(0, 4));
          data = data.filter((_, idx) => idx === 0 || (idx - 3) % 3 === 0);

          let grouped = {};
          for (let i = 1; i < data.length; i++) {
            let site = data[i][2];
            let duration = parseFloat(data[i][3]) || 0;
            if (!grouped[site]) {
              grouped[site] = [...data[i]];
              grouped[site][3] = duration;
            } else {
              grouped[site][3] += duration;
            }
          }

          let header = ["Rig", "Start", "Site", "Duration"];
          let finalData = [header, ...Object.values(grouped)];

          renderTable(finalData);
          renderGantts(finalData);
        }
      });
    });

    function renderTable(data) {
      const table = document.getElementById('csvTable');
      table.innerHTML = "";
      data.forEach((row, rowIndex) => {
        const tr = document.createElement('tr');
        row.forEach(cell => {
          const td = document.createElement(rowIndex === 0 ? 'th' : 'td');
          td.textContent = cell;
          tr.appendChild(td);
        });
        table.appendChild(tr);
      });
    }

    function renderGantts(data) {
      chartInstances.forEach(c => c.destroy());
      chartInstances = [];

      const container = document.getElementById("chartContainer");
      container.innerHTML = "";

      const rigsMap = {};
      for (let i = 1; i < data.length; i++) {
        const rig = data[i][0];
        const start = parseExcelDate(data[i][1]);
        const site = data[i][2];
        const duration = Number(data[i][3]);
        if (!start) continue;
        const end = new Date(start.getTime() + duration * 86400000);
        if (!rigsMap[rig]) rigsMap[rig] = [];
        rigsMap[rig].push({ site, start, end });
      }

      const today = new Date();
      const threeMonthsLater = new Date(today.getFullYear(), today.getMonth() + 3, today.getDate());
      const sixMonthsLater = new Date(today.getFullYear(), today.getMonth() + 6, today.getDate());

      Object.keys(rigsMap).forEach(rig => {
        const bars = rigsMap[rig].map(r => ({ y: r.site, x: [r.start, r.end] }));
        const sites = rigsMap[rig].map(r => r.site);

        const minDate = new Date(today.getFullYear(), today.getMonth(), today.getDate() - 7);
        const maxDate = sixMonthsLater;  // <-- fixed to 6 months ahead

        const title = document.createElement("h3");
        // title.textContent = `ðŸ“Š Gantt Chart - ${rig}`;
        title.textContent = `ðŸ“Š ${rig}`;
        container.appendChild(title);

        const canvas = document.createElement("canvas");
        canvas.height = Math.max(200, sites.length * 18);
        container.appendChild(canvas);

        const ctx = canvas.getContext("2d");
        const chart = new Chart(ctx, {
          type: "bar",
          data: {
            datasets: [{
              label: "Schedule",
              data: bars,
              backgroundColor: "#00bcd4",
              borderSkipped: false
            }]
          },
          options: {
            indexAxis: "y",
            responsive: false,
            maintainAspectRatio: false,
            parsing: { xAxisKey: "x", yAxisKey: "y" },
            scales: {
              x: {
                type: "time",
                time: {
                  unit: "day",
                  stepSize: 1,
                  tooltipFormat: "dd-MMM-yyyy",
                  displayFormats: { day: "dd-MMM" }
                },
                min: minDate,
                max: maxDate,
                ticks: {
                  color: "white",
                  autoSkip: false,
                  stepSize: 1,
                  source: "auto",
                  maxRotation: 0,
                  minRotation: 0,
                  callback: function(value) {
                    const d = new Date(value);
                    if (isNaN(d)) return value;
                    const dd = String(d.getDate()).padStart(2, "0");
                    const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
                    return `${dd}-${months[d.getMonth()]}`;
                  }
                },
                grid: { color: "#444" }
              },
              y: {
                type: "category",
                labels: sites,
                ticks: { color: "white", autoSkip: false }, // show all labels
                grid: { color: "#444" }
              }
            },
            plugins: {
              legend: { display: false },
              annotation: {
                annotations: {
                  futureBox: {
                    type: "box",
                    xMin: today,
                    xMax: threeMonthsLater,
                    backgroundColor: "rgba(255,0,0,0.15)",
                    borderWidth: 0
                  },
                  todayLine: {
                    type: "line",
                    xMin: today,
                    xMax: today,
                    borderColor: "red",
                    borderWidth: 2,
                    label: {
                      enabled: true,
                      content: "Today",
                      position: "start",
                      color: "red",
                      backgroundColor: "rgba(255,255,255,0.8)",
                      font: { weight: "bold" }
                    }
                  }
                }
              },
              zoom: {
                zoom: {
                  wheel: { enabled: true },
                  pinch: { enabled: true },
                  mode: "x"
                },
                pan: {
                  enabled: true,
                  mode: "x"
                },
                limits: {
                  x: { min: minDate, max: maxDate }
                }
              }
            },
            barThickness: 10,
            animation: false,
            hover: { mode: null }
          }
        });

        chartInstances.push(chart);
      });
    }
  </script>
</body>
</html>
